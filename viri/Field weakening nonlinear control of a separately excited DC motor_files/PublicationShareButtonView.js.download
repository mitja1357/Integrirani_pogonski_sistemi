"use strict";YUI.add("rg-pdfjs-text-selection",function(a){a.namespace("rg.pdfjs.plugins"),a.rg.pdfjs.plugins.textSelection=function(b,c){var d,e=function(){var d,e,f={arrowKeyCodes:[37,38,39,40],mouseUpDelay:500,enabledClassName:"selectable",selectionMadeEventName:"textselected",selectionClearedEventName:"textunselected",threshold:{sameLine:2,fontSize:1,fontSizeFactor:1.5}},g=!1,h=!1,i=!1,j=0;this.addEventListeners=function(a){"undefined"!=typeof b.getSelection&&(a.addEventListener("mousedown",k),c.addEventListener("mouseup",l),a.addEventListener("keyup",n),c.addEventListener("click",m))},this.clearSelection=function(){var b,d,e=c.selection?c.selection:null,g=window.getSelection?window.getSelection():e;for(null!==g&&(g.empty?g.empty():g.removeAllRanges()),b=c.querySelectorAll("."+f.enabledClassName),d=b.length;d--;)b[d].className="";a.fire(f.selectionClearedEventName),h=!1};var k=function(a){"textLayer"===a.target.parentNode.className&&(this.clearSelection(),p(a.target),o(a.target),g=!0)}.bind(this),l=function(a){g===!0&&(r(a),g=!1)},m=function(){if(!g&&h&&"undefined"!=typeof b.getSelection){var a=b.getSelection(),c=a.toString();""!==c&&0!==a.rangeCount||this.clearSelection()}}.bind(this),n=function(a){a.shiftKey===!0&&f.arrowKeyCodes.indexOf(a.keyCode)!==-1&&r()},o=function(a){var b=function(a,b){var c=a,d=b===-1?"previousSibling":"nextSibling";if(c[d])for(;p(c[d],c,b)&&c[d][d];)c=c[d]};b(a,1),b(a,-1)},p=function(a,b,c){return!(!a||""!==a.className||!q(a,b,c))&&(a.className=f.enabledClassName,!0)},q=function(a,b,c){if(!b)return!0;if(b.className!==f.enabledClassName)return!1;var g=a.getBoundingClientRect(),h=b.getBoundingClientRect(),k=parseInt(b.style.fontSize,10),l=parseInt(a.style.fontSize,10);if(1.1*(h.left+h.width)<g.left)return d=0,e=0,i=!1,j=0,!1;if(h.left===g.left)return d=g.left,e=g.width,!(Math.abs(k-l)>f.threshold.fontSize)&&!(Math.abs(g.top-h.top)>k*f.threshold.fontSizeFactor);if(Math.abs(g.top-h.top)<f.threshold.sameLine)return e+=g.width,!0;if(Math.abs(g.top-h.top)<k*f.threshold.fontSizeFactor){if(i)return i=!1,j=0,!(j<d);if(g.left>d&&g.left-d<.2*Math.max(e,g.width)){if(1===c)return!1;i=!0,j=d}return!0}return!1},r=function(){var c,d=b.getSelection(),e=d.getRangeAt(0),g=3!==e.commonAncestorContainer.nodeType&&e.commonAncestorContainer.className.indexOf("textLayer")===-1,i=d.toString();return""===i||0===d.rangeCount||g?(this.clearSelection(),!1):(c={range:d.getRangeAt(0),selection:d},a.fire(f.selectionMadeEventName,c),h=!0,!0)}.bind(this)},f=function(){return d?d:new e};return{init:function(a){a=a||b,f().addEventListeners(a)},clearSelection:function(){f().clearSelection()}}}(window,document)});
"use strict";YUI.add("rg-callback-timer",function(a){a.namespace("rg");var b=function(){a.Lang.isNull(this._timer)||this._timer.cancel()},c=function(){this._timer=a.Lang.later(this.get("delay"),this,d)},d=function(){var b=this.get("host"),c=this.get("callback");c.call(b),b.unplug(a.rg.CallbackTimer)};a.rg.CallbackTimer=a.Base.create("CallbackTimer",a.Plugin.Base,[],{_timer:null,initializer:function(){c.call(this)},destructor:function(){b.call(this)}},{NS:"callbackTimer",ATTRS:{delay:{value:5e3},callback:{validator:function(b){return a.Lang.isFunction(b)}}}})},"0.0.1",{requires:[]});
"use strict";YUI.add("rg-header-notify",function(a){a.namespace("rg.widget");var b,c,d=null,e=a.Base.create("HeaderMessagePositionable",a.Widget,[a.WidgetPosition,a.WidgetStack]),f='<div class="c-message-wrapper"><div class="c-message"><div class="c-message-inner"><span></span><a href="javascript:void(0);" class="close" onclick="return false;">&times;</a></div></div></div>',g={promo:"promo",attention:"attention",warning:"warning"};b=a.Base.create("HeaderAlign",a.Base,[],{_align:null,_contentNode:null,_contentWrapperNode:null,_close:null,_delay:null,initializer:function(){var b=a.Node.create(f),c=this.get("posX"),d=this.get("posY");this._contentNode=b.one("span"),this._close=b.one(".close"),this._contentWrapperNode=b.one("div"),this._align=new e({contentBox:b,render:!0,visible:!1,zIndex:101,xy:[c,d],plugins:[{fn:a.Plugin.TransitionOverlay,cfg:{duration:.2}}]}),this._createEvents()},destructor:function(){this._align.destroy(),this._align=null},setType:function(b){var c;for(c in g)g.hasOwnProperty(c)&&this._contentWrapperNode.removeClass(g[c]);a.Lang.isValue(g[b])?this._contentWrapperNode.addClass(g[b]):a.log("Type "+b+" not supported.","warn")},setText:function(b){if(a.Lang.isObject(b)){var c=[];a.Object.each(b,function(a){c.push(a)}),b=c.join("<br />")}else a.Lang.isArray(b)&&(b=b.join("<br />"));this._contentNode.setContent(b)},setDelay:function(a){this._delay=a},show:function(){this._align.show();var b=Helpers.hasOverlay(),c=a.one(".header-wrapper"),d=a.one("window"),e=parseInt(d.get("scrollTop"));if(c){var f=parseInt(c.get("offsetHeight"));this.set("posY",f)}var g=Math.max(this.get("posY"),e);b?(this._align.set("zIndex",1100),this._align.set("xy",[0,0])):this._align.set("xy",[0,g]),this._align.plug(a.rg.CallbackTimer,{delay:this._delay,callback:this._align.hide})},hide:function(){this._align.unplug(a.rg.CallbackTimer),this._align.hide()},_createEvents:function(){this._close.on("click",this._align.hide,this._align)}},{ATTRS:{posY:{value:51,writeOnce:!0},posX:{value:0,writeOnce:!0}}}),c=function(c){return a.Lang.isNull(d)&&(d=new b(c)),d},a.rg.notify=function(b,d){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3;if(window&&window.rgEnableYUIForwarding)return a.fire("emitLegacyNotification",b,d);var f,g=a.one(".header-wrapper-logged-out");f=g?c({posY:g.get("offsetHeight")}):c(),f.setText(b),f.setType(d),f.setDelay(e),f.show()}},"0.0.1",{requires:["widget","widget-position","widget-stack","rg-overlay","rg-callback-timer"]});
"use strict";YUI.add("rg.core.util.ClipboardPlugin",function(a){a.namespace("rg.core.util"),a.rg.core.util.ClipboardPlugin=a.Base.create("ClipboardPlugin",a.Plugin.Base,[],{handlers:[],initializer:function(b){var c=a.one("document");b&&(b.textPattern&&this.set("textPattern",b.textPattern),b.htmlPattern&&this.set("htmlPattern",b.htmlPattern),b.context&&this.set("context",b.context)),this.handlers=[],this.handlers.push(c.on("copy",this.attachMessageToClipboard,this))},destructor:function(){a.Array.each(this.handlers,function(a){a.detach()})},sendAjaxExperimentData:function(b){var c=a.one("body").hasClass("logged-out"),d=c?"Logged out":"Logged in",e=d+" - "+this.get("context");a.rg.ajax("application.AjaxCommon.ajaxClipboardExperiment.html",{context:e}),window.ga&&window.ga("send","social","researchgate","copy",e+": "+b)},attachMessageToClipboard:function(b){if(b=b._event||window.event,b.clipboardData||window.clipboardData){var c,d,e,f,g=new Date,h=window.datetimeHelpers.getFullDatestring(g),i=this.get("textPattern").replace(/\{\{title\}\}/g,document.title).replace(/\{\{url\}\}/g,window.location.href).replace(/\{\{currentYear\}\}/g,g.getFullYear()).replace(/\{\{currentDate\}\}/g,h),j=this.get("htmlPattern").replace(/\{\{title\}\}/g,document.title).replace(/\{\{url\}\}/g,window.location.href).replace(/\{\{currentYear\}\}/g,g.getFullYear()).replace(/\{\{currentDate\}\}/g,h),k=document.createElement("div"),l=150,m=!!b.clipboardData,n=m?"text/plain":"text",o=m?b.clipboardData:window.clipboardData;if("undefined"!=typeof window.getSelection){if(e=window.getSelection(),f=e.baseNode||e.focusNode,!a.one(f).ancestors(".abstract, .pub-abstract, .document-viewer, .publication-full-text-container, .topic-post-text")._nodes.length)return;if(c=e.toString(),c.length<l)return;if(e.rangeCount){for(var p=0,q=e.rangeCount;p<q;++p)k.appendChild(e.getRangeAt(p).cloneContents());d=k.innerHTML}o.setData(n,c+" "+i),m&&o.setData("text/html",d+j)}else{if(!o.getData("Text"))return;if(c=o.getData("Text"),c.length<l)return;o.clearData(),o.setData(n,c+" "+i)}this.sendAjaxExperimentData(c),b.preventDefault()}}},{NS:"ClipboardPlugin",ATTRS:{textPattern:{value:"\n\n{{title}}. Available from: {{url}} [accessed {{currentDate}}]."},htmlPattern:{value:'\n<br><i>{{title}}</i>. Available from: <a href="{{url}}">{{url}}</a> [accessed {{currentDate}}].'},context:{value:null}}})},"1.0.0",{requires:["datetimeHelpers"]});
"use strict";YUI.add("rg-page-leave",function(a){var b="gallery-dom0beforeunload",c=window.onbeforeunload;window.onbeforeunload=function(d){var e=d||window.event;c&&c(e);var f,g=new a.DOMEventFacade(e);if(a.fire(b,g),f=g.returnValue)return e.returnValue=f,f},a.Env.evt.plugins.beforeunload={on:function(){var c=a.Array(arguments,0,!0);return c[0]=b,a.on.apply(a,c)}},a.namespace("rg.plugins"),a.rg.plugins.PageLeavePlugin=a.Base.create("PageLeavePlugin",a.Plugin.Base,[],{handlers:[],initializer:function(a){a&&a.msg&&this.set("pageLeaveMsg",a.msg),this.handlers=[],this._setupPageLeave()},destructor:function(){a.Array.each(this.handlers,function(a){a.detach()})},_setupPageLeave:function(){a.Array.each(this.get("pageLeaveOverrideSelectors"),function(b){this.handlers.push(a.delegate("click",this._disablePageLeavePrevent,this.get("host"),b,this))},this),this.handlers.push(a.on("disablePageLeave",this._disablePageLeavePrevent,this)),this.handlers.push(a.on("enablePageLeave",this._enablePageLeavePrevent,this)),this.handlers.push(a.on("beforeunload",function(a){if(this.get("pageLeavePreventEnabled"))return a=a||window.event,a&&(a.returnValue=this.get("pageLeaveMsg")),this.get("pageLeaveMsg")},this))},_disablePageLeavePrevent:function(){this.set("pageLeavePreventEnabled",!1)},_enablePageLeavePrevent:function(){this.set("pageLeavePreventEnabled",!0)}},{NS:"PageLeavePlugin",ATTRS:{pageLeavePreventEnabled:{value:!0},pageLeaveOverrideSelectors:{value:[]},pageLeaveMsg:{value:"If you leave now, all the details you have entered so far will be lost."}}})},"1.0.0",{requires:[]});
"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};YUI.add("rg.views.application.PdfJsReaderView",function(a){a.namespace("rg.views.application"),a.rg.views.application.PdfJsReaderView=a.Base.create("application.PdfJsReaderView",a.rg.WidgetView,[],{events:{".pdf-js-viewer":{click:"hideComments",mouseenter:"showCursorPromo",mouseleave:"hideCursorPromo"},global:{"PdfJsReaderView:setLinkIdToTempHighlight":"setLinkIdToTempHighlight"}},setLinkIdToTempHighlight:function(b){this.isHighlighted=!0;var c=this,d=b.linkId;a.all(".temp-highlight").each(function(b){b.getAttribute("data-target-link-id")||(b.setAttribute("data-target-link-id",d),b.removeClass("temp-highlight"),a.one(b).detach("click").on("click",function(a){a.stopPropagation(),c.highlightClick(a.target,d)}))})},_isCommentsWidgetLoaded:!1,_firedDownload:!1,_lastViewportMilestone:0,_isDocumentLoaded:!1,isHighlighted:!1,trackedPages:new Set,highlightClick:function(b,c){var d=b.left?b.left:parseInt(b.getStyle("left")),e=b.top?b.top-b.height:parseInt(b.getStyle("top"))-parseInt(b.getStyle("height")),f=this,g=this.isHighlighted?30:10;f.highlightMenu||(f.highlightMenu=a.one(".publication-highlight-tooltip")),f.highlightMenu.addClass("publication-highlight-tooltip-visible"),f.highlightMenu.addClass("publication-highlight-tooltip-delete"),f.highlightMenu.setStyle("left",d),f.highlightMenu.setStyle("top",e-g),f.highlightMenu.all(".publication-highlight-tooltip-button").detach("click").on("click",function(b){b.preventDefault(),b.stopPropagation(),f.highlightMenu.removeClass("publication-highlight-tooltip-visible"),a.fire("legacyHighlightDeleteAdapter:deleteHighlight",{rootId:f.data.composerRootId,parentId:f.data.composerParentId,linkId:c}),f.removeHighlights(c)})},_fireInteractionBasedDownload:function(){var b=this;if(!b._firedDownload){var c=window.innerHeight,d=parseInt(a.one(".pdf-js-viewer").getComputedStyle("height"),10);if(!(d<100)){var e=b._getScrolledDistance(),f=e/((c+d)/100);f>10&&(b._firedDownload=!0,b.trackDownload("scrolldown"))}}},countPages:function(){return this.pages.length?this.pages.length-1:0},trackPageView:function(){var b=this.viewportPage();null===b.page||this.trackedPages.has(b.page)||(this.trackedPages.add(b.page),a.rg.ajax(this.data.pageReadTrackUrl,{pubId:this.data.publicationUid,page:b.page},null,this,null,"POST"))},viewportPage:function(){var b={above:!1,below:!1,page:null},c=null;return document.getElementById("pageContainer1")?(a.all(".js-pdf-reader-page").each(function(a){var b=a.getDOMNode().getBoundingClientRect();!c&&b.top+b.height>0&&(c=parseInt(a.getData("pdf-page"),10))}),c<1?b.above=!0:c>this.countPages()?b.below=!0:b.page=c,b):b},closestPage:function(){var a=this.viewportPage();return a.above?1:a.below?this.countPages():a.page},_getScrolledDistance:function(){var b=window.innerHeight,c=window.pageYOffset,d=a.one(".pdf-js-viewer").getXY()[1];return c+b-d},_loadDocument:function(b){var c,d=this,e=this;e.pages=[];var f=this.get("container").one(".pdf-js-viewer");if(f.empty(),e.selections=[],e.data.pdfCommentsActive,e.data.comments){var g=e.data.comments.length;for(c=0;c<g;c++){var h=e.data.comments[c];if(h&&h.highlight){var i=e.rgPathToCoords(h.highlight);null!==i&&e.selections.push({coords:i,type:"comment",id:h.readerCommentId,linkId:h.linkId,canDelete:h.canDelete})}}}if(e.data.figures&&e.data.figures.length>0){var j=e.data.figures.length;for(c=0;c<j;c++){var k=e.data.figures[c];if(k&&k.props&&k.props.coords){var l=e.rgPathToCoords(k.props.coords);null!==l&&e.selections.push({coords:l,type:"caption",id:k.assetId})}}}e.data.productMentions&&e.data.productMentions.items&&e.data.productMentions.items.forEach(function(a){null!==a.productId&&a.assetKey===e.data.assetId&&a.assetPaths&&["catalogueNumber","manufacturer","name"].forEach(function(b){var c=e.rgPathToCoords(a.assetPaths[b+"Path"]);null!==c&&e.selections.push({coords:c,type:"productmention",id:a.id})})}),e.selections.push({coords:e._getSelectionsFromUrl()});var m=PDFJS.getDocument(b);m.onProgress=function(b){a.fire("pdfjs:progress",b)},m.promise.then(function(b){if(d._isDocumentLoaded=!0,d.pdfDocument=b,d.data.onlyRenderFirstPage&&b.numPages>1)d.setupPage(1,2),a.fire("publication:setupCompleted"),widgetLoader.loadWidget("publication.detailPromos.PublicationDetailPdfLoadMorePromo.html",{publicationType:d.data.publicationType},function(c){c.render({append:this.get("container")}),a.once("PDFJS:renderRestOfPublication",function(){e.data.onlyRenderFirstPage=!1,a.rg.ajax("application.AjaxCommon.ajaxScoreGoal.html",{goal:e.data.readMoreExperimentGoal,viewIds:[e.data.readMoreExperimentViewId]}),e.messageHandlers.push(a.one("document").on("scroll",a.debounce(25,e.updatePagesInView),e));for(var c=1;c<b.numPages;c++)e.setupPage(c+1,e.maximumNumberOfPagesToRender)})},d,!0);else{for(var c=0;c<b.numPages;c++)e.setupPage(c+1,e.maximumNumberOfPagesToRender);a.fire("publication:setupCompleted")}}).catch(function(){a.rg.notify("The PDF didn't load. Please try again.","warning"),d.removeRenderingIndicator()}),e.messageHandlers.push(document.addEventListener("textlayerrendered",e._findMargins.bind(e))),e.data.pdfCommentsActive&&e.data.canSelect&&(a.rg.pdfjs.plugins.textSelection.init(f.getDOMNode()),a.on("textselected",this.selectEventHandler,this),a.on("textunselected",this.unselectEventHandler,this))},originalPageNumber:function(a){var b=this.data.slurpMetadata;return b&&b.isCropped&&a>=b.croppedAfter?a+b.croppedUntil-b.croppedAfter+1:a},setupPage:function(b,c){var d=this,e=this;e.pdfPageViews=e.pdfPageViews||{},e.pages[b]=null;var f=this.get("container").one(".pdf-js-viewer"),g=document.createElement("div"),h=document.createElement("div");g.setAttribute("class","js-pdf-reader-page"),g.setAttribute("id","pdf-reader-page-"+b),g.setAttribute("data-pdf-page",b),f.append(g),h.setAttribute("class","pdf-page-separator"),h.textContent="page "+e.originalPageNumber(b),f.insertBefore(h,g),e.data.slurpMetadata&&e.data.slurpMetadata.croppedAfter===b+1&&widgetLoader.loadWidget("publication.detailPromos.PublicationDetailPdfSlurpInterstitial.html",{publicationUid:e.data.publicationUid},function(b){b.render({afterNode:a.one(g)})}),this.pdfDocument.getPage(b).then(function(a){var f=a.getViewport(1).width,h=d._calculateScale(f),i=a.getViewport(h),j=!1,k=null;if(g.style.minHeight=Math.round(i.height+18)+"px","number"==typeof e.data.pageToRenderFirst&&b===e.data.pageToRenderFirst&&(j=!0,e.data.pageToRenderFirst=null,k=e.data.scrollToCoords,e.data.scrollToCoords=null),b<c||j){var l=new PDFJS.PDFPageView({container:g,id:b,scale:.75*h,defaultViewport:a.getViewport(h),textLayerFactory:new PDFJS.DefaultTextLayerFactory,annotationLayerFactory:new PDFJS.DefaultAnnotationLayerFactory});l.setPdfPage(a),e.pdfPageViews[b]=l,e.renderPageContainer(g,l,a,b,j,k)}else g.setAttribute("data-is-rendered","false");d.removedRenderingIndicator||d.removeRenderingIndicator()})},removeRenderingIndicator:function(){this.removedRenderingIndicator=!0;var b=a.one(".pdf-js-container");if(null!==b){b.hasClass("rendering")&&b.removeClass("rendering"),b.hasClass("rendering-custom")&&b.removeClass("rendering-custom");var c=b.one(".progress-bar");c&&c.hide()}},renderPageContainer:function(b,c,d,e,f,g){var h=this;b.setAttribute("data-is-rendered","true"),c.draw().then(function(){if(a.one(b).all("a").each(function(a){a.getAttribute("href")&&a.setAttribute("href","deref/"+encodeURIComponent(a.getAttribute("href")))}),h._loadSelections(h.selections,e,d),document.location.hash&&h.scrollToCommentFromURL(),f){var c=0;if(g){var i=h.getPageContainer(e),j=h.convertPdfRectangleToCss(d,g,i);c=j[1]}a.rg.scrollTo(a.one("document"),a.one(b).getXY()[1]+c-200,.8)}})},removeHighlights:function(b){a.all(".publication-comment-reference[data-target-link-id="+b+"]").each(function(a){a.remove()}),a.all(".publication-citation-reference-box[data-target-link-id="+b+"]").each(function(a){a.remove()})},_calculateScale:function(a){var b=1e3;return b/a},scrollToCommentFromURL:function(){var b=document.location.hash.match(/^#feedback\/(\d+)$/i);if(b&&b[1]){var c=b[1],d=a.one(".publication-comment-reference[data-target-comment-id="+c+"]");if(d){var e=d.getY();a.one("window").set("scrollTop",e-120),this.showComment(c,e)}}},updatePagesInView:function(){var b=this,c=b.closestPage();a.all(".js-pdf-reader-page").each(function(a){var d=parseInt(a.getAttribute("data-pdf-page"),10);Math.abs(d-c)<Math.ceil(b.maximumNumberOfPagesToRender/2)?null!==a&&"true"!==a.getAttribute("data-is-rendered")&&b.pdfDocument.getPage(d).then(function(c){if(!b.pdfPageViews.hasOwnProperty(d)||null===b.pdfPageViews[d]){var e=c.getViewport(1).width,f=b._calculateScale(e),g=new PDFJS.PDFPageView({container:a,id:d,scale:.75*f,defaultViewport:c.getViewport(f),textLayerFactory:new PDFJS.DefaultTextLayerFactory,annotationLayerFactory:new PDFJS.DefaultAnnotationLayerFactory});g.setPdfPage(c),b.pdfPageViews[d]=g}b.renderPageContainer(a,b.pdfPageViews[d],c,d)}):(null!==a.one(".page")&&(a.one(".publication-highlight-tooltip")&&(b.highlightMenu.removeClass("publication-highlight-tooltip-visible"),b.highlightMenu.appendTo(b.get("container"))),a.one(".page").empty()),b.pdfPageViews.hasOwnProperty(d)&&null!==b.pdfPageViews[d]&&b.pdfPageViews[d].destroy(),a.setAttribute("data-is-rendered","false"))})},_findMargins:function(a){if(a.hasOwnProperty("detail")&&a.detail.hasOwnProperty("pageNumber")){var b,c,d,e=this,f=a.detail.pageNumber,g=e.getPageContainer(f),h=g.querySelector(".textLayer"),i=h.querySelectorAll("div"),j=0,k={},l=g.getBoundingClientRect().width,m={},n=0,o=l/6;if(null===e.pages[f]){for(j;j<i.length;j++)b=i[j],d=Math.round(b.getBoundingClientRect().right),k.hasOwnProperty(d)?k[d]+=1:k[d]=1,c=Math.round(b.getBoundingClientRect().left),m.hasOwnProperty(c)?m[c]+=1:m[c]=1;for(j in k)k.hasOwnProperty(j)&&k[j]>5&&parseInt(j,10)>n&&(n=parseInt(j,10));for(j in m)m.hasOwnProperty(j)&&m[j]>5&&parseInt(j,10)<parseInt(l,10)&&!(m[l]+5<m[j])&&(l=j);e.pages[f]={},e.pages[f].rightMargin=g.getBoundingClientRect().width-n<o?n-g.getBoundingClientRect().left:0,e.pages[f].leftMargin=l<o?l-g.getBoundingClientRect().left:0}}},_getCommentId:function(a){var b=a.querySelectorAll(".publication-comment-reference[data-comment-id]"),c=[],d=0,e="page-"+a.getAttribute("data-pdf-page")+"-comment-";return b.length?(Array.prototype.forEach.call(b,function(a){c.push(parseInt(a.getAttribute("data-comment-id")),10)}),Math.max.apply(null,c)):e+(d+1)},convertPdfRectangleToCss:function(a,b,c){var d=a.view[0],e=a.view[1],f=a.view[3]-e,g=c.querySelector("canvas").getClientRects()[0],h=g.height,i=h/f,j=a.getViewport(i),k=b[0]+d,l=f-b[1]+e,m=k+b[2],n=l-b[3],o=j.convertToViewportRectangle([k,l,m,n]).map(function(a){return Math.round(100*a)/100});return o},_convertCssRectangleToPdf:function(a,b,c){var d=a.view[0],e=a.view[1],f=a.view[3]-e,g=c.querySelector("canvas").getClientRects()[0],h=g.height,i=h/f,j=a.getViewport(i),k=j.convertToPdfPoint(b[0],b[1]),l=j.convertToPdfPoint(b[2],b[3]),m=[];return m[0]=k[0]-d,m[1]=f-k[1]+e,m[2]=l[0]-k[0],m[3]=k[1]-l[1],m.map(function(a){return Math.round(100*a)/100})},_getSelectionsFromUrl:function(){var b,c,d,e,f,g,h=this,i=a.QueryString.parse(document.location.hash.substr(1).replace(/\?|%3F/g,":")),j={};for(var k in i)if(i.hasOwnProperty(k)){d=k.split(":"),c=d.length;for(var l=0;l<c;l+=4)b=d[1+l],f=d[3+l],"undefined"!=typeof f&&(e=f.replace(/[^,]/g,"").length>3,j[b]||(j[b]=[]),f=f.replace(/\(/g,""),b>1&&(h.data.onlyRenderFirstPage=!1,h.data.pageToRenderFirst=parseInt(b,10)),e?(g=f.split(")"),g.pop(),g.forEach(function(a){j[b].push(a.split(",").map(parseFloat))})):j[b].push(f.split(",").map(parseFloat)))}return h.data.pageToRenderFirst&&j[h.data.pageToRenderFirst]&&(h.data.scrollToCoords=j[h.data.pageToRenderFirst][0]),j},_loadSelections:function(a,b,c){var d,e=this;a.forEach(function(a){var f,g;for(d in a.coords)a.coords.hasOwnProperty(d)&&parseInt(d,10)===b&&(f=a.coords[d],g=e.getPageContainer(b),e.showCanvasHighlightsPerPage(f,c,g,a.id,a.type,a.linkId,a.canDelete))})},getPageContainer:function(a){return document.getElementById("pageContainer"+a)},showCanvasHighlightsPerPage:function(b,c,d,e,f,g,h){var i=this,j="caption"===f;b.forEach(function(b){var k=i.convertPdfRectangleToCss(c,b.slice(0),d),l=document.createElement("div"),m=Math.min(k[0],k[2]),n=Math.min(k[1],k[3]),o=Math.abs(k[1]-k[3]);if(l.setAttribute("style","left:"+m+"px;top:"+n+"px;width:"+Math.abs(k[0]-k[2])+"px;height:"+o+"px;"),e&&"comment-input-dummy"!==e&&!j)"productmention"===f?(l.setAttribute("class","publication-product-mention-reference"),l.setAttribute("data-target-product-id",e),a.one(l).on("click",function(b){b.stopPropagation(),i.data.productClickMilestone&&a.rg.ajax("application.AjaxCommon.ajaxScoreGoal.html",{goal:i.data.productClickMilestone}),a.fire("PublicationProductMention:click",e)})):g&&(l.setAttribute("class","publication-comment-reference"),l.setAttribute("data-target-comment-id",e),l.setAttribute("data-target-link-id",g),h&&a.one(l).on("click",function(a){a.stopPropagation(),i.highlightClick({left:m,top:n,height:o},g)}));else{var p=document.createElement("div"),q=i.pages[d.getAttribute("data-page-number")],r=null!==q&&"undefined"!=typeof q.leftMargin?q.leftMargin:30,s=Math.abs(k[1]-k[3])+20;if(j){var t=parseInt(a.one(d).getComputedStyle("width"),10);Math.min(k[0],k[2])>200&&Math.abs(k[0]-k[2])<t/2&&(r=Math.min(k[0],k[2])-15),p.setAttribute("class","publication-caption-indicator"),l.setAttribute("data-target-asset-id",e),l.className+=" publication-caption-overlay"}else p.setAttribute("class","publication-citation-reference-indicator"),l.className+=" publication-citation-reference-box temp-highlight";p.setAttribute("style","left: "+r+"px;top:"+(Math.min(k[1],k[3])-10)+"px;height:"+s+"px"),d.appendChild(p)}if(d.appendChild(l),j){var u=a.one(l);u.on("click",function(a){a.stopPropagation(),i.openFiguresOverlay(e,!0)}),u.on("mouseover",function(){i.hideCursorPromo(),"object"!==_typeof(u.tooltip)&&u.plug(a.rg.widget.TooltipPlugin,{content:'<span class="ico-plus-large publication-figures-enlarge-link-plus"></span><span class="publication-figures-enlarge-link-label">Enlarge figure</span>',delay:100,type:"manual",additionalClasses:"tooltip-attention publication-caption-tooltip"}),u.tooltip.show()}),u.on("mouseout",function(){"object"===_typeof(u.tooltip)&&u.tooltip.hide()})}})},openFiguresOverlay:function(a,b){var c=this,d=b?"clickOnOverlay":"clickOnPill";c.data.figureOverlayUrls&&widgetLoader.loadWidgetInDialog(c.data.figureOverlayUrls[d],{publicationUid:c.data.publicationUid,figureItemAssetId:a,openedFromPdf:!0},null,null,null,null,"overlay-mask-dark")},authorPillEventHandler:function(b){var c,d,e,f=this,g=a.one(b.target);if(g&&b.pageY)if(d=g.ancestor(".publication-comment-subpill"),e=g.ancestor(".js-publication-comment"),c=null===d?e.getAttribute("data-comment-id"):d.getAttribute("data-comment-id"),c.length>0){if(b.stopPropagation(),f.activeCommentId===c)return;f.showComment(c,b.pageY)}else c=null===d?e.getAttribute("data-asset-id"):d.getAttribute("data-asset-id"),c.length>0&&(b.stopPropagation(),f.openFiguresOverlay(c,!1))},showComment:function(b,c,d){var e;a.all(".js-publication-comments-anchored .js-publication-comment").hide(),a.all(".publication-comment-reference-active").removeClass("publication-comment-reference-active");var f=a.one(".js-publication-comments-anchored [data-comment-id="+b+"]");if(f){var g=a.all(".publication-comment-reference[data-target-comment-id="+b+"]");g.addClass("publication-comment-reference-active");var h=a.one(".publication-comment-reference[data-target-comment-id="+b+"]").ancestor(".js-pdf-reader-page"),i=h.getAttribute("data-pdf-page");if(i&&this.pages[i]&&this.pages[i].rightMargin&&this.pages[i].rightMargin>0){var j=this.pages[i].rightMargin,k=parseInt(h.one(".textLayer").getStyle("width"),10),l=70;e=l+j<k?k-j-l:0}else e=0;this.get("container").addClass("has-active-comment-references"),this.hideCommentPlaceholder(),f.setStyles({top:c-this.get("container").getY(),left:-e}),f.show(),a.one(".pdf-js-container").addClass("pdf-js-container-shifted"),this.activeCommentId=b,d&&f.one(".js-comment-input").focus()}},hideComments:function(){a.all(".js-publication-comments-anchored .js-publication-comment").hide(),a.all(".js-publication-comments-anchored .js-new-comment-placeholder").hide(),a.all(".publication-comment-reference-active").removeClass("publication-comment-reference-active"),a.one(".pdf-js-container").removeClass("pdf-js-container-shifted"),a.all(".has-active-comment-references").removeClass("has-active-comment-references"),this.activeCommentId=null},showCommentInput:function(b,c,d,e,f){var g,h=this,i=b.pageY,j=a.one(".js-publication-comments-anchored .js-new-comment-placeholder"),k=j.one(".js-add-comment-input"),l=j.one(".comment-label-quote-text"),m=j.one(".js-cancel-comment"),n=j.one(".js-add-comment");if(a.fire("enablePageLeave"),h.showCanvasHighlightsPerPage(c.coords,f,e,"comment-input-dummy"),k.set("value","").detach("keyup").on("keyup",function(){a.Lang.later(0,null,function(){k.get("value").trim().length>4?n.removeClass("btn-inactive"):n.addClass("btn-inactive")})}),n.addClass("btn-inactive"),l.setHTML("&ldquo;"+c.text+"&rdquo;"),a.Lang.later(50,null,function(){k.focus(),a.rg.ajax("application.AjaxCommon.ajaxScoreGoal.html",{goal:"experimentMilestoneInteractionPublicationHighlightBoxFocused"})}),m.detach("click").on("click",function(b){b.preventDefault(),b.stopPropagation(),a.fire("disablePageLeave"),j.hide(),a.one(".pdf-js-container").removeClass("pdf-js-container-shifted")}),n.detach("click").on("click",function(g){g.preventDefault(),g.stopPropagation(),k.get("value").trim().length>4&&(a.fire("disablePageLeave"),h.storeComment(c,d,b,e,f,k.get("value")),j.addClass("rendering"))}),a.all(".js-publication-comments-anchored .js-publication-comment").hide(),a.one(".pdf-js-container").addClass("pdf-js-container-shifted"),d&&h.pages[d]&&h.pages[d].rightMargin&&h.pages[d].rightMargin>0){var o=h.pages[d].rightMargin,p=parseInt(a.one(e).one(".textLayer").getStyle("width"),10),q=70;g=q+o<p?p-o-q:0}else g=0;j.setStyles({top:i-this.get("container").getY(),left:-g}),j.show()},showHighlightPlaceholder:function(b){var c=a.one(".js-publication-comments-anchored .js-interaction-ajax-placeholder");a.all(".js-publication-comments-anchored .js-publication-comment").hide(),a.one(".pdf-js-container").addClass("pdf-js-container-shifted"),c.setStyle("top",b-this.get("container").getY()),c.show()},hideCommentPlaceholder:function(){var b=a.one(".js-publication-comments-anchored");b.one(".js-interaction-ajax-placeholder").hide(),b.one(".js-new-comment-placeholder").hide().removeClass("rendering")},unselectEventHandler:function(){a.all(".js-promo-length-info").remove(),this.highlightMenu&&this.highlightMenu.removeClass("publication-highlight-tooltip-visible")},selectEventHandler:function(b){var c,d=b.selection,e=b.range,f=d.toString(),g=this;g.cursorPromoDismissed||g.dismissCursorPromo(),a.all(".js-promo-length-info").remove(),c=d.baseNode||d.anchorNode;var h=parseInt(a.one(c.parentNode).ancestor(".js-pdf-reader-page").getAttribute("data-pdf-page"),10);this.pdfDocument.getPage(h).then(function(b){var d=a.one(c.parentNode).ancestor(".textLayer").getDOMNode();if(null===d)return void a.rg.pdfjs.plugins.textSelection.clearSelection();var i,j,k,l,m=d.parentElement,n=m.querySelector("canvas").getClientRects()[0],o=e.getClientRects(),p={},q=57,r=[];a.rg.ajax(g.data.experimentEndpoint,{}),p.coords=[],p.text=f;for(var s=0;s<o.length;s++){j=o[s],i=[],i[0]=j.left-n.left,i[1]=j.top-n.top,i[2]=i[0]+j.width,i[3]=i[1]+j.height;var t=g._convertCssRectangleToPdf(b,i,m);("undefined"==typeof k||j.top<k.top)&&(k=j),r.push(t),s>1&&(l=r[s-1],t[0]===l[0]&&Math.abs(t[1]-l[1])<5&&p.coords.pop()),p.coords.push(t)}if(f.length<10||f.split(" ").length>60){var u=f.length<10?"more":"less",v=a.Node.create('<div class="publication-comments-cursor-promo-container js-promo-length-info"><div class="publication-comments-cursor-promo js-promo-content"><span class="publication-comments-cursor-promo-icon ico-marker-rgf"></span>Please select '+u+" text to highlight or comment</div></div>");return v.one(".publication-comments-cursor-promo").setStyles({position:"absolute",left:k.left-n.left,top:k.top-n.top}),void a.one(m).append(v)}g.highlightMenu.removeClass("publication-highlight-tooltip-delete"),g.highlightMenu.addClass("publication-highlight-tooltip-visible"),g.highlightMenu.setStyle("left",k.left-n.left),g.highlightMenu.setStyle("top",k.top-n.top-q),g.highlightMenu.all(".publication-highlight-tooltip-button").detach("click").on("click",function(c){c.preventDefault(),c.stopPropagation();var d=c.target.hasClass("js-comment");g.showCanvasHighlightsPerPage(p.coords,b,m,"comment-input-dummy"),g.highlightMenu.removeClass("publication-highlight-tooltip-visible");var e=g.coordsToRgPath(p.coords,h);a.fire("legacyHighlightSectionAdapter:requestHighlightComment",{path:e,coords:p.coords,text:p.text,type:d?"comment":"highlight",rootId:g.data.composerRootId,parentId:g.data.composerParentId})}),g.highlightMenu.appendTo(m)})},coordsToRgPath:function(a,b){var c="pag:"+b+":mrect:";return a.forEach(function(a){c+="("+a.join()+")"}),c},rgPathToCoords:function(a){if(!a||a.indexOf(":")===-1&&a.indexOf(",")===-1)return null;var b,c=a.indexOf(":")!==-1,d={},e=c?a.split(":"):a.split(","),f=c?e[1]:e.shift();if(c){b="mrect"===e[2]?e[3].trim().substring(1,e[3].trim().length-1).split(")("):[e[3].trim()],d[f]||(d[f]=[]);for(var g=0,h=b.length;g<h;++g)d[f].push(b[g].split(",").map(parseFloat))}else d[f]=[e.map(parseFloat)];return d},storeComment:function(b,c,d,e,f,g){var h=this,i=this.coordsToRgPath(b.coords,c),j=a.one('[data-target-comment-id="comment-input-dummy"]'),k=function(g){var i={id:g.commentId,coords:{}};i.coords[c]=b.coords,h.selections.push(i),j&&j.remove(!0),h.showCanvasHighlightsPerPage(b.coords,f,e,g.commentId),widgetLoader.loadWidget("publication.PublicationComment.html",{readerCommentId:g.commentId,isAnchored:!0,readerDocId:h.data.readerDocId,publicationUid:h.data.publicationUid},function(b){a.fire("pdf-comment-change"),b.render({append:a.one(".js-publication-comments-anchored"),after:function(){var b="comment"===d.target.getData("type");b?h.showComment(g.commentId,d.pageY,!0):a.rg.notify("Your highlight has been saved and is publicly visible.","promo")}})}),a.fire("publicationCommentCreated",{publicationUid:h.data.publicationUid})};"string"==typeof g&&(g=g.trim());var l={comment:g,createdAt:(new Date).toISOString(),highlight:i,highlightedText:b.text,assetId:h.data.assetId,assetType:h.data.assetType,type:g?this.data.interactionType.comment:this.data.interactionType.highlight,publicationUid:h.data.publicationUid,et:"comment"===d.target.getData("type")?"c":"h"};a.rg.ajax(h.data.commentEndpoint,l,function(b){if(b.success){var c=b.result;k(c)}else a.rg.notify("Your comment couldn't be saved. Please try again.","warning")})},trackDownload:function(b){a.rg.ajax(this.data.downloadTrackUrl,{type:b,linkId:this.data.linkId,pubId:this.data.publicationUid},null,this,null,"POST")},afterRendered:function(){var b=this,c=a.one("document");b.originalWidth=parseInt(this.get("container").getComputedStyle("width"),10),b.maximumNumberOfPagesToRender=5,b.data.pageToRenderFirst=null,PDFJS.workerSrc=b.data.javascriptPath+"javascript/lib/pdfjs/build/pdf.worker.js",PDFJS.externalLinkRel="nofollow",PDFJS.externalLinkTarget=PDFJS.LinkTarget.BLANK,b.data.downloadUrl=decodeURIComponent(b.data.downloadUrl),b.highlightMenu=a.one(".publication-highlight-tooltip"),a.one("document").plug(a.rg.core.util.ClipboardPlugin,{context:"publications"}),c.plug(a.rg.plugins.PageLeavePlugin),a.fire("disablePageLeave"),b.messageHandlers=[],b.messageHandlers.push(a.on("author-pill-clicked",this.authorPillEventHandler.bind(b))),b.messageHandlers.push(a.on("pdf-js-version-change",function(a){a.url&&(b.data.downloadUrl=a.url,b.data.urlHash=a.urlHash,b._loadDocument(a.url))})),b.messageHandlers.push(a.on("windowresize",function(){var a=parseInt(b.get("container").getComputedStyle("width"),10);(a!==b.originalWidth||"undefined"!=typeof b.previousWidth&&a!==b.previousWidth)&&(b._loadDocument(b.data.downloadUrl),b.previousWidth=a)})),b.messageHandlers.push(b._loadDocument(b.data.downloadUrl)),b.messageHandlers.push(c.on("scroll",b._fireInteractionBasedDownload,b)),b.data.onlyRenderFirstPage||b.messageHandlers.push(c.on("scroll",a.debounce(25,b.updatePagesInView),b)),b.messageHandlers.push(c.on("scroll",a.debounce(2e3,b.trackPageView),b)),b.data.pdfCommentsActive&&widgetLoader.preloadWidget("application.PdfJsReaderCommentMarks.html",{assetId:b.data.assetId,figureAssetIds:b.data.figureAssetIds,readerDocId:b.data.readerDocId},!0),a.all(".publication-resource-dropdown-item").on("click",this.hideComments)},showCursorPromo:function(){a.fire("PublicationCommentsCursorPromo:show")},hideCursorPromo:function(){a.fire("PublicationCommentsCursorPromo:hide")},dismissCursorPromo:function(){a.fire("PublicationCommentsCursorPromo:dismiss"),this.cursorPromoDismissed=!0},destructor:function(){this.messageHandlers&&this.messageHandlers.forEach(function(a){a.detach()})}},{ATTRS:{}})},"1.0.0",{requires:["pdfjs","gallery-debounce","rg-pdfjs-text-selection","rg-ajax","json","querystring","rg-header-notify","rg.core.util.ClipboardPlugin","rg-page-leave"]});
"use strict";YUI.add("rg.views.publication.publicationactions.PublicationShareButtonView",function(a){a.namespace("rg.views.publication.publicationactions"),a.rg.views.publication.publicationactions.PublicationShareButtonView=a.Base.create("publication.publicationactions.PublicationShareButtonView",a.rg.WidgetView,[],{events:{".js-publication-share":{click:"openShareDialog"},global:{"PublicationShareButton:openShareDialog":"openShareDialog"}},openShareDialog:function(){var b=this;this.data.viewIds&&this.data.milestone&&a.rg.ajax("application.AjaxCommon.ajaxScoreGoal.html",{goal:this.data.milestone,viewIds:this.data.viewIds}),widgetLoader.getResultFromDialog("application.UserSelectionDialog.html",{title:"Who do you want to recommend this to?",groups:[{title:"suggestions",url:"application.UserSelectionDialog.getUserCombinedSuggestions.html"}],cta:"Recommend",cancelLabel:"Cancel",searchEndpoint:"application.UserSelectionDialog.getUserSearchSuggestions.html",requireSelection:!0},null,"user-selection-dialog-popup").then(function(a){widgetLoader.loadWidgetInDialog("publication.PublicationShareMessageDialog.html",{publicationUid:b.data.publicationUid,userIds:a})}).catch(function(b){if(b.widgetErrors)a.rg.notify(b.widgetErrors,"warning");else if(!b.isCancelled)return Promise.reject(b)})}},{ATTRS:{}})},"0.0.1",{requires:["rg-tooltip"]});
