"use strict";YUI.add("rg.views.application.PdfJsReaderCommentMarksView",function(a){var b=function(){var b,c,d,e=[],f=function(){var b={},c=[];this.getOverlappingMark=function(a,b,d){for(var f,g=0;g<c.length;g++)if(f=a+b+d,a>=c[g].top&&a<c[g].bottom||f>c[g].top&&f<=c[g].bottom)return e[c[g].markId];return null},this.isHighlightOverlapping=function(){},this.addAuthorPill=function(a,b,d,e){c.push({markId:a,top:b,bottom:b+d+e})},this.getPageOffsets=function(c){if(!b["page"+c]){var d=document.getElementById("pdf-reader-page-"+c);b["page"+c]={top:a.one(d).getXY()[1],width:d.offsetWidth}}return b["page"+c]}},g=function(b,e){var f,g,h=null,i=null,j=38,k=5,l=25,m=b,n=e,o=[];this.getComment=function(){return m},this.getDomElement=function(){return g},this.addSubMark=function(a){if(o.length<2&&f){o.push(a);var b=a.getComment(),c=f.className,d=document.createElement("span"),e=2===o.length?" publication-comment-subpill-2":"";o.length<2?c+=" publication-interaction-pill-2":(c=c.replace("publication-interaction-pill-2",""),c+=" publication-interaction-pill-3"),d.className="publication-comment-subpill"+e,d.setAttribute("data-comment-id",b.id),d.innerHTML=t(b.profileImg),f.appendChild(d),f.className=c}};var p=this,q=function(){for(var a=0;a<m.highlightPaths.length;a++)r(m.highlightPaths[a],m.type,m.id,m.page);var b=d.getOverlappingMark(h,j,k),c=null!==b&&"like"===m.type;null===b||c?(g=document.createElement("div"),g.className="js-publication-comment js-publication-comment-"+m.id,"like"===m.type||"figurecomment"===m.type?g.setAttribute("data-asset-id",m.id):g.setAttribute("data-comment-id",m.id),g.appendChild(s(m,c))):b&&b.addSubMark(p)},r=function(b,c,d,e){var f,g=parseInt(e,10),j=a.one(".js-pdf-reader-container").getXY()[1],k=a.one("#pageContainer"+g).getXY()[1],l=k-j;f="like"===c||"figurecomment"===c?document.querySelector("#pageContainer"+g+' .publication-caption-overlay[data-target-asset-id="'+d+'"]'):document.querySelector("#pageContainer"+g+' .publication-comment-reference[data-target-comment-id="'+d+'"]'),null===h&&(i=g,h=parseInt(getComputedStyle(f).top,10),h+=l)},s=function(b,e){var g,m=h,o=d.getPageOffsets(i).width,p=c.pages[i]?c.pages[i].leftMargin:0,q=p-l>0?p-30:0,r="highlight"!==b.type?"ico-comment-publication-interaction":"ico-highlight-publication-interaction";return f=document.createElement("div"),f.setAttribute("style","right:"+(o-q)+"px;top:"+m+"px;height:"+j+"px;z-index:100"),f.className="publication-interaction-pill","like"===b.type?(g=b.likeCount>1?"likes":"like",f.className+=" publication-interaction-likes",e===!0&&(f.className+=" publication-interaction-likes-nudge-down"),f.innerHTML='<span class="publication-interaction-likes-count">'+b.likeCount+" </span> "+g):f.innerHTML='<span class="rf '+r+'"></span>'+t(b.profileImg),f.addEventListener("click",function(b){a.fire("author-pill-clicked",b)}),f.addEventListener("mouseover",function(b){b.stopPropagation(),a.fire("PublicationCommentsCursorPromo:hide")}),d.addAuthorPill(n,m,j,k),f},t=function(a){return'<img src="'+a+'" width="30" height="30" class="img-circle"/>'};q()};return{generate:function(a,h,i){d=d||new f;var j=e.map(function(a){return a.getComment().id});if(null!==c&&null!==b)for(var k=0;k<a.length;k++)j.indexOf(a[k].id)===-1&&parseInt(a[k].page,10)===i&&e.push(new g(a[k],k));if(h)for(k=0;k<e.length;k++)h.appendChild(e[k].getDomElement());return a},getMarkAt:function(a){return e[a]?e[a]:null},removeMark:function(a){e=e.filter(function(b){return b.getComment().id!==a})},getAllMarks:function(){return e},hasFinishedRenderingPdf:function(){var c=b.pdfInfo.numPages;return null!==b&&c===a.all(".js-pdf-reader-page .page .canvasWrapper").size()&&a.one("#pageContainer"+c+" .textLayer div")},setPdfReader:function(a){a&&a._data.widget&&(c=a._data.widget,b=c.pdfDocument,a.setStyle("position","relative"))}}}();a.namespace("rg.views.application"),a.rg.views.application.PdfJsReaderCommentMarksView=a.Base.create("application.PdfJsReaderCommentMarksView",a.rg.WidgetView,[],{events:{},destructor:function(){this.messageHandlers&&this.messageHandlers.forEach(function(a){a.detach()})},afterRendered:function(){var c=a.one(".js-pdf-reader-container"),d=this;b.setPdfReader(c),d.messageHandlers=[],this.data.comments&&this.data.comments.length&&d.messageHandlers.push(a.on("pdf-page-loaded",function(a){b.generate(d.data.comments,d.get("container"),a)})),d.messageHandlers.push(a.on("pdf-comment-delete",function(a){b.removeMark(a),d.get("container").empty(),d.reload()})),d.messageHandlers.push(a.on("pdf-comment-change",function(){d.get("container").empty(),d.reload()}))}},{ATTRS:{}})});
